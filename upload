<?php
require 'PhotoUpload.php';

function delete_file($filepath)
{
    if(is_file($filepath)) {
        unlink($filepath);
    }
}

function create_photo( $file_path, $orig_name )
{
    # Upload the received image file to Cloudinary
    $result = \Cloudinary\Uploader::upload($file_path, array(
            "tags" => "product_photo_uploader",
            "folder" => "Products",
            "public_id" => $orig_name,
    ));

    unlink($file_path);
    error_log("Upload result: " . \PhotoUpload\ret_var_dump($result));
    $photo = \PhotoUpload\create_photo_model($result);
    return $result;
}

//$current = getcwd();
//$uploadDir = $current . '/uploads';

$uploadDir = '/mnt/cloudinary/Products';

$files = preg_grep('~\.(jpg|jpeg|png)$~', scandir($uploadDir));

if(empty($files)){
    exit('no files in directory!');
}

//limit to first 500 items in directory, throttle to limit
$process_files = array_slice($input, 0, 500);

$files_data = array();

foreach($process_files as $file) {
    $checkFile = 'Products/' . $file;
    $check = \PhotoUpload\check_photo_uploaded($checkFile);

    $filePath = $uploadDir . '/' . $file;

    if($check === NULL) {
        array_push($files_data, create_photo($filePath,$file));
        delete_file($filePath);
    } else {
        echo $check['public_id'] . " already uploaded on " . $check['created_at'] . PHP_EOL;
        delete_file($filePath);
    }

}

